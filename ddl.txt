DROP TABLE USER_T CASCADE CONSTRAINT;
DROP TABLE PLACE CASCADE CONSTRAINT;
DROP TABLE STORY CASCADE CONSTRAINT;
DROP TABLE REVIEW CASCADE CONSTRAINT;
DROP TABLE COMMENT_T CASCADE CONSTRAINT;
DROP TABLE LIKE_T CASCADE CONSTRAINT;
DROP TABLE TAG CASCADE CONSTRAINT;
DROP TABLE STORY_TAG CASCADE CONSTRAINT;

-- 1. 사용자 (USER) 엔티티
CREATE TABLE USER_T (
    USER_ID NUMBER PRIMARY KEY,
    ID VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD VARCHAR2(100) NOT NULL,
    NAME VARCHAR2(100),
    EMAIL VARCHAR2(100) UNIQUE,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- 2. 장소 (PLACE) 엔티티
-- 장소 자체의 정보만 담으며, 스토리는 이 장소에 귀속되지 않음 (별도의 좌표 사용)
CREATE TABLE PLACE (
    PLACE_ID NUMBER PRIMARY KEY,
    NAME VARCHAR2(200) NOT NULL,
    AVERAGE_RATING NUMBER(3,2),
    LATITUDE NUMBER(10, 8) NOT NULL, -- 위도
    LONGITUDE NUMBER(11, 8) NOT NULL, -- 경도
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- 3. 스토리 (STORY) 엔티티
CREATE TABLE STORY (
    STORY_ID NUMBER PRIMARY KEY,
    USER_ID NUMBER, -- 유저가 삭제됐을 경우를 위해 NULL 허용
    IMAGE_URL VARCHAR2(500),
    CONTENT NCLOB,
    LATITUDE NUMBER(10, 8) NOT NULL, -- 스토리가 발생한 위치 (장소와 독립적)
    LONGITUDE NUMBER(11, 8) NOT NULL,
    LIKES NUMBER(10),
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT FK_STORY_USER FOREIGN KEY (USER_ID) REFERENCES USER_T(USER_ID) ON DELETE SET NULL
	-- 유저 삭제 시 null로 설정
);

-- 4. 리뷰 (REVIEW) 엔티티
CREATE TABLE REVIEW (
    REVIEW_ID NUMBER PRIMARY KEY,
    USER_ID NUMBER, -- 유저가 삭제됐을 경우를 위해 NULL 허용
    PLACE_ID NUMBER NOT NULL, -- Reviewed: 어느 장소에 대한 리뷰인지
    TITLE VARCHAR2(200),
    CONTENT CLOB,
    RATING NUMBER(2, 1) CHECK (RATING >= 0 AND RATING <= 5),
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT FK_REVIEW_USER FOREIGN KEY (USER_ID) REFERENCES USER_T(USER_ID) ON DELETE SET NULL,
	-- 유저 삭제 시 null로 설정
    CONSTRAINT FK_REVIEW_PLACE FOREIGN KEY (PLACE_ID) REFERENCES PLACE(PLACE_ID) ON DELETE CASCADE
	-- 장소 삭제 시 함께 삭제됨
);

-- 5. 댓글 (COMMENT) 엔티티
CREATE TABLE COMMENT_T (
    COMMENT_ID NUMBER PRIMARY KEY,
    USER_ID NUMBER, -- 유저가 삭제됐을 경우를 위해 NULL 허용
    REVIEW_ID NUMBER NOT NULL, -- Commented to: 어느 리뷰에 대한 댓글인지 (조건 2 반영)
    CONTENT NVARCHAR2(2000) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT FK_COMMENT_USER FOREIGN KEY (USER_ID) REFERENCES USER_T(USER_ID) ON DELETE SET NULL,
	-- 유저 삭제 시 null로 설정
    CONSTRAINT FK_COMMENT_REVIEW FOREIGN KEY (REVIEW_ID) REFERENCES REVIEW(REVIEW_ID) ON DELETE CASCADE
	-- 리뷰 삭제 시 함께 삭제됨
);

-- 6. 좋아요 (LIKE) 엔티티 (STORY에만 연결, 조건 3 반영)
CREATE TABLE LIKE_T (
    USER_ID NUMBER NOT NULL, -- Who LIKED: 누가 눌렀는지 (PK의 일부)
    STORY_ID NUMBER NOT NULL, -- Which Story: 어느 스토리에 대한 좋아요인지 (PK의 일부)
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    -- 복합 기본 키 설정: 한 사용자는 한 스토리에 한 번만 좋아요를 누를 수 있음
    CONSTRAINT PK_LIKE PRIMARY KEY (USER_ID, STORY_ID),
    CONSTRAINT FK_LIKE_USER FOREIGN KEY (USER_ID) REFERENCES USER_T(USER_ID) ON DELETE CASCADE,
	-- 유저 삭제 시 함께 삭제됨
    CONSTRAINT FK_LIKE_STORY FOREIGN KEY (STORY_ID) REFERENCES STORY(STORY_ID) ON DELETE CASCADE
	-- 스토리 삭제 시 함께 삭제됨
);

-- 7. 태그 (TAG) 엔티티
CREATE TABLE TAG (
    TAG_ID NUMBER PRIMARY KEY, -- PK를 Name 대신 ID로 변경하여 관리 용이성 향상
    NAME VARCHAR2(100) NOT NULL UNIQUE -- 실제 태그 이름
);

-- 8. 스토리-태그 (STORY_TAG) 중간 엔티티 (N:M 관계 구현)
CREATE TABLE STORY_TAG (
    STORY_ID NUMBER NOT NULL,
    TAG_ID NUMBER NOT NULL,
    -- 복합 기본 키 설정: 한 스토리에 같은 태그는 한 번만 등록 가능
    CONSTRAINT PK_STORY_TAG PRIMARY KEY (STORY_ID, TAG_ID),
    CONSTRAINT FK_STAG_STORY FOREIGN KEY (STORY_ID) REFERENCES STORY(STORY_ID) ON DELETE CASCADE,
	-- 스토리 삭제 시 함께 삭제됨
    CONSTRAINT FK_STAG_TAG FOREIGN KEY (TAG_ID) REFERENCES TAG(TAG_ID)
);

DROP SEQUENCE USER_SEQ;
DROP SEQUENCE PLACE_SEQ;
DROP SEQUENCE STORY_SEQ;
DROP SEQUENCE REVIEW_SEQ;
DROP SEQUENCE COMMENT_SEQ;
DROP SEQUENCE TAG_SEQ;

CREATE SEQUENCE USER_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE PLACE_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE STORY_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE REVIEW_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE COMMENT_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE TAG_SEQ START WITH 1 INCREMENT BY 1;

commit;